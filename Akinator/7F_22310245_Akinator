#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
import time

ARCHIVO = "arbol_peliculas.json"

# ------------------ CARGAR / CREAR ÃRBOL INICIAL ------------------
def cargar_arbol():
    if not os.path.exists(ARCHIVO) or os.stat(ARCHIVO).st_size == 0:
        arbol_inicial = {
            "pregunta": "Â¿Tu pelÃ­cula es de acciÃ³n?",
            "si": {
                "pregunta": "Â¿Tu pelÃ­cula es de superhÃ©roes?",
                "si": {
                    "pregunta": "Â¿Tu pelÃ­cula es de DC?",
                    "si": {"pelicula": "Superman"},
                    "no": {
                        "pregunta": "Â¿Tu pelÃ­cula es de Marvel?",
                        "si": {"pelicula": "Iron Man"},
                        "no": {"aprende": True}
                    }
                },
                "no": {
                    "pregunta": "Â¿Tu pelÃ­cula es de automÃ³viles?",
                    "si": {"pelicula": "RÃ¡pidos y Furiosos"},
                    "no": {"aprende": True}
                }
            },
            "no": {
                "pregunta": "Â¿Tu pelÃ­cula es de comedia?",
                "si": {
                    "pregunta": "Â¿Tu pelÃ­cula es de comedia romÃ¡ntica?",
                    "si": {"pelicula": "Anyone but You"},
                    "no": {
                        "pregunta": "Â¿Tu pelÃ­cula es de Adam Sandler?",
                        "si": {"pelicula": "Son como niÃ±os"},
                        "no": {
                            "pregunta": "Â¿Tu pelÃ­cula tiene un protagonista mudo?",
                            "si": {"pelicula": "Mr. Bean"},
                            "no": {"aprende": True}
                        }
                    }
                },
                "no": {
                    "pregunta": "Â¿Tu pelÃ­cula es de romance?",
                    "si": {
                        "pregunta": "Â¿Tu pelÃ­cula ocurre en un barco?",
                        "si": {"pelicula": "Titanic"},
                        "no": {
                            "pregunta": "Â¿Tu pelÃ­cula es sobre un cientÃ­fico?",
                            "si": {"pelicula": "La teorÃ­a del todo"},
                            "no": {
                                "pregunta": "Â¿Tu pelÃ­cula es un romance triste?",
                                "si": {"pelicula": "Bajo la misma estrella"},
                                "no": {"aprende": True}
                            }
                        }
                    },
                    "no": {
                        "pregunta": "Â¿Tu pelÃ­cula es un musical?",
                        "si": {
                            "pregunta": "Â¿Tu pelÃ­cula es sobre jazz?",
                            "si": {"pelicula": "La La Land"},
                            "no": {
                                "pregunta": "Â¿Tu pelÃ­cula es sobre un circo?",
                                "si": {"pelicula": "The Greatest Showman"},
                                "no": {
                                    "pregunta": "Â¿Tu pelÃ­cula es sobre un artista?",
                                    "si": {"pelicula": "Rocketman"},
                                    "no": {"aprende": True}
                                }
                            }
                        },
                        "no": {
                            "pregunta": "Â¿Tu pelÃ­cula es de ciencia ficciÃ³n?",
                            "si": {
                                "pregunta": "Â¿Tu pelÃ­cula tiene sables lÃ¡ser?",
                                "si": {"pelicula": "Star Wars: A New Hope"},
                                "no": {
                                    "pregunta": "Â¿Tu pelÃ­cula tiene gusanos gigantes?",
                                    "si": {"pelicula": "Dune"},
                                    "no": {
                                        "pregunta": "Â¿Tu pelÃ­cula es cyberpunk?",
                                        "si": {"pelicula": "Akira"},
                                        "no": {"aprende": True}
                                    }
                                }
                            },
                            "no": {"aprende": True}
                        }
                    }
                }
            }
        }
        guardar_arbol(arbol_inicial)
        return arbol_inicial

    with open(ARCHIVO, "r", encoding="utf-8") as f:
        return json.load(f)


# ------------------ GUARDAR ------------------
def guardar_arbol(arbol):
    with open(ARCHIVO, "w", encoding="utf-8") as f:
        json.dump(arbol, f, ensure_ascii=False, indent=4)


# ------------------ UTILIDADES ------------------
def pedir_si_no(prompt):
    while True:
        r = input(prompt + " (si/no): ").strip().lower()
        if r in ("si", "s"):
            return "si"
        if r in ("no", "n"):
            return "no"
        print("â— Responde solo 'si' o 'no'.")


# ------------------ APRENDIZAJE (CAMINO 2) ------------------
def aprender(nodo):
    pelicula_antigua = nodo.get("pelicula", None)

    if pelicula_antigua:
        print(f"\nğŸ¤” Oh, no era '{pelicula_antigua}'.")
    else:
        print("\nğŸ¤” Parece que no he identificado la pelÃ­cula.")

    pelicula_correcta = input("ğŸ¬ Â¿CuÃ¡l era tu pelÃ­cula? ").strip()
    while not pelicula_correcta:
        pelicula_correcta = input("Escribe el nombre de la pelÃ­cula (no vacÃ­o): ").strip()

    if pelicula_antigua:
        ejemplo = f"Para diferenciar '{pelicula_correcta}' de '{pelicula_antigua}'"
    else:
        ejemplo = f"Para diferenciar '{pelicula_correcta}' de lo que conocÃ­a"
    nueva_pregunta = input(f"â“ Escribe una pregunta de sÃ­/no que {ejemplo}: ").strip()
    while not nueva_pregunta:
        nueva_pregunta = input("Escribe la pregunta (no vacÃ­o): ").strip()

    respuesta_correcta = pedir_si_no(f"Para '{pelicula_correcta}', Â¿la respuesta a esa pregunta es")

    if respuesta_correcta == "si":
        nuevo = {
            "pregunta": nueva_pregunta,
            "si": {"pelicula": pelicula_correcta},
            "no": {"pelicula": pelicula_antigua} if pelicula_antigua else {"aprende": True}
        }
    else:
        nuevo = {
            "pregunta": nueva_pregunta,
            "si": {"pelicula": pelicula_antigua} if pelicula_antigua else {"aprende": True},
            "no": {"pelicula": pelicula_correcta}
        }

    nodo.clear()
    nodo.update(nuevo)

    guardar_arbol(arbol_global)
    print("\nâœ… Gracias â€” he aprendido. ActualicÃ© el Ã¡rbol.\n")
    time.sleep(1)


# ------------------ RECORRIDO / JUEGO ------------------
def jugar(arbol):
    nodo = arbol
    camino = []
    while True:
        if nodo.get("aprende", False):
            aprender(nodo)
            return "aprendido"

        if "pelicula" in nodo:
            respuesta = pedir_si_no(f"\nğŸ¬ Â¿Tu pelÃ­cula es '{nodo['pelicula']}'?")
            if respuesta == "si":
                print("ğŸ‰ Â¡AdivinÃ©!")
                return "acierto"
            else:
                aprender(nodo)
                return "aprendido"

        if "reiniciar" in nodo and nodo["reiniciar"]:
            print("\nğŸ” Reiniciando el juego...\n")
            return "reiniciar"

        if "pregunta" in nodo:
            respuesta = pedir_si_no(nodo["pregunta"])
            camino.append((nodo["pregunta"], respuesta))
            nodo = nodo["si"] if respuesta == "si" else nodo["no"]
            continue

        print("âš ï¸ Nodo invÃ¡lido encontrado en el Ã¡rbol. Reiniciando juego.")
        return "error"


# ------------------ LOOP PRINCIPAL ------------------
def iniciar_akinator():
    print("ğŸ¥ Bienvenido al Akinator de PelÃ­culas (versiÃ³n Ã¡rbol corregido) ğŸ¬\n")
    global arbol_global
    arbol_global = cargar_arbol()

    while True:
        resultado = jugar(arbol_global)
        if resultado in ("acierto", "aprendido"):
            volver = pedir_si_no("\nğŸ® Â¿Quieres jugar otra vez?")
            if volver == "si":
                print("\nğŸ” Reiniciando...\n")
                continue
            else:
                print("\nğŸ‘‹ Â¡Gracias por jugar! Se guardÃ³ el Ã¡rbol en", ARCHIVO)
                break
        elif resultado == "reiniciar":
            continue
        else:
            print("\nâš ï¸ FinalizÃ³ por una razÃ³n inesperada.")
            break


# ------------------ EJECUCIÃ“N ------------------
if __name__ == "__main__":
    iniciar_akinator()
