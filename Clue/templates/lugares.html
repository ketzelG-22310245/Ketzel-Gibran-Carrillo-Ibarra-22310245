<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{{ titulo }}</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Playfair Display", serif;
        color: #eee;
      }

      body {
        background: url("{{ url_for('static', filename='Images/city2.jpg') }}")
          no-repeat center center fixed;
        background-size: cover;
        margin: 0;
        padding: 40px;
        box-sizing: border-box;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: -1;
      }

      .titulo-caso {
        position: fixed;
        top: 20px;
        left: 40px;
        font-family: "Cinzel", serif;
        font-size: 32px;
        color: #ff4040;
        text-shadow: 0 0 20px rgba(255, 64, 64, 0.7);
        z-index: 10;
      }

      h2.subtitulo {
        margin-top: 100px;
        margin-left: 40px;
        font-family: "Cinzel", serif;
        color: #ffffff;
        font-size: 1.2em;
      }

      .container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 40px;
        padding: 60px 80px;
        height: calc(100vh - 220px);
        box-sizing: border-box;
      }

      .lista-lugares {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 25%;
        justify-content: center;
      }

      .lista-lugares button {
        padding: 12px 20px;
        background-color: rgba(30, 30, 30, 0.9);
        border: none;
        border-radius: 12px;
        color: #fff;
        font-size: 18px;
        font-family: "Cinzel", serif;
        text-align: left;
        box-shadow: 0 0 10px rgba(255, 64, 64, 0.25);
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lista-lugares button:hover {
        background-color: #ff4040;
        box-shadow: 0 0 25px rgba(255, 64, 64, 0.8);
        transform: translateX(8px);
      }

      .lista-lugares button.visited {
        text-decoration: line-through;
        opacity: 0.65;
        cursor: default;
        transform: none;
        box-shadow: none;
        pointer-events: none;
      }

      .imagen-preview {
        position: fixed;
        top: 48px;
        right: 48px;
        width: 520px;
        height: 320px;
        border-radius: 18px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 0 36px rgba(255, 64, 64, 0.75);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.35s ease, visibility 0.35s ease;
        z-index: 100;
      }

      .imagen-preview.visible {
        opacity: 1;
        visibility: visible;
      }

      .declarar {
        position: fixed;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 120;
        opacity: 0;
        pointer-events: none;
      }

      .boton {
        background-color: rgba(30, 30, 30, 0.95);
        color: #fff;
        padding: 12px 30px;
        border-radius: 10px;
        font-size: 1.1em;
        font-family: "Cinzel", serif;
        text-decoration: none;
        box-shadow: 0 0 10px rgba(255, 64, 64, 0.3);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .boton:hover {
        background-color: #ff4040;
        box-shadow: 0 0 25px rgba(255, 64, 64, 0.8);
        transform: scale(1.05);
      }

      .fade-in {
        animation: fadeInUp 450ms ease forwards;
      }

      @keyframes fadeInUp {
        0% {
          transform: translateX(-50%) translateY(18px);
          opacity: 0;
          pointer-events: none;
        }
        100% {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
          pointer-events: auto;
        }
      }

      .credit {
        text-align: center;
        margin-top: 60px;
        color: #888;
        font-size: 13px;
      }

      @media (max-height: 700px) {
        .container {
          padding: 40px 40px;
          height: calc(100vh - 160px);
        }
        .imagen-preview {
          width: 420px;
          height: 260px;
          right: 30px;
          top: 70px;
        }
        .titulo-caso {
          font-size: 24px;
          left: 24px;
          top: 12px;
        }
      }
    </style>
  </head>

  <body>
    <div class="titulo-caso">{{ titulo }}</div>

    <h2 class="subtitulo">Escoge un lugar para investigar</h2>

    <div class="container" data-total="{{ lugares|length }}">
      <div class="lista-lugares">
        {% for nombre in lugares.keys() %}
        <button
          id="btn-{{ loop.index0 }}"
          data-nombre="{{ nombre }}"
          data-imagen="{{ url_for('static', filename='Images/' + nombre|replace(' ', '_')|lower + '.jpg') }}"
          class="{% if nombre in lugares_visitados %}visited{% endif %}"
          {%
          if
          nombre
          in
          lugares_visitados
          %}disabled{%
          endif
          %}
          onclick="handleLugarClick(event, '{{ nombre }}', {{ loop.index0 }})"
        >
          {{ nombre }}
        </button>
        {% endfor %}
      </div>
    </div>

    <div class="imagen-preview" id="preview"></div>

    {% if todos_visitados %}
    <div
      class="declarar fade-in"
      id="declarar-servidor"
      style="opacity: 1; pointer-events: auto"
    >
      <a href="{{ url_for('juego') }}" class="boton">Declarar culpable</a>
    </div>
    {% endif %}

    <div class="credit">Â© 2025 Proyecto Clue - Sistemas Expertos</div>

    <script>
      const botones = document.querySelectorAll(".lista-lugares button");
      const preview = document.getElementById("preview");
      const totalLugares = botones.length;

      let timeout;

      botones.forEach((btn) => {
        btn.addEventListener("mouseenter", () => {
          if (btn.classList.contains("visited")) return;
          clearTimeout(timeout);
          const img = btn.getAttribute("data-imagen");
          preview.style.backgroundImage = `url('${img}')`;
          preview.classList.add("visible");
        });

        btn.addEventListener("mouseleave", () => {
          timeout = setTimeout(() => preview.classList.remove("visible"), 200);
        });
      });

      preview.addEventListener("mouseenter", () => clearTimeout(timeout));
      preview.addEventListener("mouseleave", () => {
        timeout = setTimeout(() => preview.classList.remove("visible"), 200);
      });

      function contarVisitados() {
        return document.querySelectorAll(".lista-lugares button.visited")
          .length;
      }

      function mostrarBotonDeclarar() {
        const serverBtn = document.getElementById("declarar-servidor");
        if (serverBtn) {
          serverBtn.classList.add("fade-in");
          serverBtn.style.opacity = "1";
          serverBtn.style.pointerEvents = "auto";
          return;
        }

        if (document.getElementById("declarar-cliente")) return;

        const div = document.createElement("div");
        div.className = "declarar fade-in";
        div.id = "declarar-cliente";
        div.innerHTML = `<a href="/juego" class="boton">Declarar culpable</a>`;
        document.body.appendChild(div);
      }

      function asegurarBotonDeclarar() {
        if (contarVisitados() >= totalLugares && totalLugares > 0) {
          mostrarBotonDeclarar();
        }
      }

      asegurarBotonDeclarar();

      function handleLugarClick(evt, nombre, index) {
        const btn = document.getElementById(`btn-${index}`);

        if (btn.classList.contains("visited") || btn.disabled) {
          window.location.href = `/investigar/${encodeURIComponent(nombre)}`;
          return;
        }

        fetch(`/marcar_visitado/${encodeURIComponent(nombre)}`, {
          method: "POST",
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        })
          .then(() => {
            btn.classList.add("visited");
            btn.disabled = true;
            preview.classList.remove("visible");
            asegurarBotonDeclarar();
          })
          .catch((err) => {
            console.warn("Error marcando visitado:", err);
            btn.classList.add("visited");
            btn.disabled = true;
            asegurarBotonDeclarar();
          })
          .finally(() => {
            setTimeout(() => {
              window.location.href = `/investigar/${encodeURIComponent(
                nombre
              )}`;
            }, 160);
          });
      }
    </script>
  </body>
</html>
